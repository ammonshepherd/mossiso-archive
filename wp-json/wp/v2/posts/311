{"id":311,"date":"2009-09-02T15:12:02","date_gmt":"2009-09-02T21:12:02","guid":{"rendered":"http:\/\/historicalwebber.mossiso.com\/?p=311"},"modified":"2013-02-01T13:55:55","modified_gmt":"2013-02-01T18:55:55","slug":"multiple-php-instances-with-one-apache","status":"publish","type":"post","link":"https:\/\/mossiso.com\/2009\/09\/02\/multiple-php-instances-with-one-apache\/","title":{"rendered":"Multiple PHP Instances With One Apache"},"content":{"rendered":"<p>&nbsp;<\/p>\n<h3>Long-winded Introduction<\/h3>\n<p>It took me a couple of days to figure this out due to lack of decent tutorials and not enough confidence in my Linux skills to build programs from source. I think I have the hang of it now, and write this up with the intent on providing another, or the only, tutorial on setting up CentOS 5 with multiple instances of PHP using one Apache install. That being said, there are a number of good tutorials out there, just none of them explicitly for CentOS and some leave out some details that n00bs like me get confused about.<\/p>\n<p><a href=\"http:\/\/www.aditus.nu\/jpgraph\/apache2suse10.php\">PHP4 and PHP5 on SuSE 10.1<\/a> &#8211; This was by far the most helpful of the tutorials. Even though it was written for SuSE, it works almost straight across for CentOS.<\/p>\n<p>There is also a great list of instructions in the comments on the php.net site under installing PHP for Apache 2.0 on Unix systems (see <a href=\"http:\/\/www.php.net\/manual\/en\/install.unix.apache2.php#90478\">http:\/\/www.php.net\/manual\/en\/install.unix.apache2.php#90478<\/a>).<\/p>\n<p>I found this one after I wrote up this tutorial at <a href=\"http:\/\/cuadradevelopment.com\/blog\/26\/multiple-php-versions-with-apache-using-fastcgi-on-os-x\/\">http:\/\/cuadradevelopment.com<\/a>. It&#8217;s a bit different, but should work as well.<\/p>\n<p>There are basically two different ways I could have done this. 1- run a single instance of Apache, and run one instance of PHP as a module, and other installs as CGI. 2- run several instances of Apache, each with it&#8217;s own instance of PHP as a module. I chose to do the first method for no particular reason. <a href=\"http:\/\/blog.dreamhosters.com\/kbase\/index.cgi?area=2933\">Dreamhost<\/a> has a post about the good and bad with running PHP as CGI.<\/p>\n<p>So basically, the steps are: 1. Set up Apache and have PHP install as a module. 2. Configure and make another instance of PHP to run as CGI. 3. Add a virtual host to Apache running under a different port to access the PHP as CGI.<br \/>\n<!--more--><\/p>\n<h3>Set up Apache with PHP module<\/h3>\n<p>So here&#8217;s what I did to get the basic Apache, PHP and MySQL working. This sets up the first PHP install to run as a module in Apache:<\/p>\n<p>From a clean install of CentOS 5 (virtually no packages selected during initial install), I installed the following packages:<\/p>\n<p><code>$ yum install gcc make subversion ImageMagick php php-cli php-common php-ldap php-mysql php-pdo php-pear php-devel bzip2-devel libxml2-devel mysql mysql-server mysql-devel mod_auth_mysql httpd httpd-manual<\/code><\/p>\n<p>From there I needed to get PHP 5.2.x, so I did the following to get PHP, Apache, MySQL and PEAR all set up.<\/p>\n<ol>\n<li><strong>Step 1:<\/strong> GET PHP 5.2.x<br \/>\nCheck out instructions and packages here: <a href=\"http:\/\/blog.famillecollet.com\/pages\/Config-en\">http:\/\/blog.famillecollet.com\/pages\/Config-en<\/a><\/p>\n<pre>$ wget http:\/\/download.fedora.redhat.com\/pub\/epel\/5\/i386\/epel-release-5-2.noarch.rpm\r\n$ wget http:\/\/rpms.famillecollet.com\/el5.i386\/remi-release-5-4.el5.remi.noarch.rpm\r\n$ rpm -Uvh remi-release-5<strong>.rpm epel-release-5<\/strong>.rpm\r\n$ yum\u2014enablerepo=remi update php-pear php<\/pre>\n<p>Copy the \/etc\/php.ini file from the \/etc\/php.ini.default:<\/p>\n<pre>$ cp \/etc\/php.ini.default \/etc\/php.ini<\/pre>\n<p>Change the following lines:<\/p>\n<ul>\n<li>1. upload_max_filesize = 20M #line 573<\/li>\n<li>2. mysql.default_socket =\/path\/to\/mysql\/mysql.sock #about line 736<\/li>\n<li>3. mysqli.default_socket =\/path\/to\/mysql\/mysql.sock #about line 771<\/li>\n<\/ul>\n<\/li>\n<li><strong>Step 2:<\/strong>Edit \/etc\/httpd\/conf\/httpd.conf by changing the following lines\n<ul>\n<li>1. Listen xxx.xxx.xxx.xxx:80 #line 134<\/li>\n<li>2. ServerAdmin admin@email.org #line 251<\/li>\n<li>3. ServerName somesite.org #line 265<\/li>\n<li>4. DocumentRoot \u201d\/path\/to\/htdocs\u201d #line 282<\/li>\n<li>5. &lt;Directory \u201d\/path\/to\/htdocs\u201d&gt; #line 307<\/li>\n<li>6. AllowOverride All #line 328<\/li>\n<li>7. DirectoryIndex index.php index.html index.html.var #line 392<\/li>\n<\/ul>\n<\/li>\n<li><strong>Step 3:<\/strong> Create the \/etc\/my.cnf file for MySQL<br \/>\n[code]<\/p>\n<pre>[mysqld]\r\ndatadir=\/path\/to\/mysql\r\nsocket=\/path\/to\/mysql\/mysql.sock\r\nuser=mysql\r\n# Default to using old password format for compatibility with mysql 3.x\r\n# clients (those using the mysqlclient10 compatibility package).\r\nold_passwords=1\r\n\r\n[client]\r\nsocket=\/path\/to\/mysql\/mysql.sock\r\n\r\n[mysqld_safe]\r\nlog-error=\/var\/log\/mysqld.log\r\npid-file=\/var\/run\/mysqld\/mysqld.pid<\/pre>\n<p>[\/code]<\/li>\n<li><strong>Step 4:<\/strong> Start apache and mysql and set them to start on boot up:<br \/>\n<blockquote>\n<pre>$ service httpd start\r\n$ service mysqld start\r\n$ chkconfig mysqld on\r\n$ chkconfig httpd on<\/pre>\n<\/blockquote>\n<\/li>\n<li><strong>Step 5:<\/strong> Set the MySQL password for root<br \/>\n<blockquote>\n<pre>$ mysqladmin -u root password \u2018XXXXXX\u2019<\/pre>\n<\/blockquote>\n<\/li>\n<li><strong>Step 6:<\/strong> install Phing and other PEAR packages<br \/>\n<blockquote>\n<pre>$ pear channel-discover pear.phing.info\r\n$ pear channel-discover pear.phpunit.de\r\n$ pear install phing\/phing\r\n$ pear install PhpDocumentor\r\n$ pear install XML_Beautifier\r\n$ pear install PHPUnit\r\n$ pecl install Xdebug<\/pre>\n<\/blockquote>\n<\/li>\n<\/ol>\n<h3>Configure second version of PHP<\/h3>\n<p>From here we need to install a second version of PHP. Grab the version you want from <a href=\"http:\/\/www.php.net\/releases\/\">http:\/\/www.php.net\/releases\/<\/a>, and stick that any where you want to (usually your root&#8217;s home directory is fine). I&#8217;m installing PHP 5.2.4, so I&#8217;ll use that in my examples.<\/p>\n<p>Unpack the tarball and enter the directory it created.<\/p>\n<pre>$ tar -xjf php-5.2.4.tar.bz2<\/pre>\n<p>Now, you&#8217;ll need to determine which modules you need to install. For this part I used the steps from the php.net comment under &#8220;my approach for determining required modules&#8221; (copied here, without permission, but with lots of gratitude and full credit going to the author of the comment).<\/p>\n<pre>my approach for determining required modules\r\n------------------------------------\r\n1. get the list of the modules\r\n     $  php -m | grep -v -e Modules] -e ^$ &gt; php-default-modules\r\n\r\n2. create the configure script\r\n$  for i in $(cat php-default-modules); do echo -n \"--with-$i \"&gt;&gt; phpconfigure.sh ;done\r\n\r\n     2.2 add #!\/bin\/bash to the top line, and .\/configure to the second line.\r\n          Each of the --with-* need to be on the second line.\r\n\r\n3. run the configure script, and iterate through the \"Configure script errors\"\r\n    section below until it completes properly\r\n\r\n    $ .\/phpconfigure.sh\r\n\r\n4. at the end of the output, look for a notice of unknown options\r\n\r\n     Notice: Following unknown configure options were used:\r\n     --with-date\r\n     --with-gum-disease\r\n\r\n     Check '.\/configure --help' for available options\r\n\r\n5. as suggested, execute '$ .\/configure --help' and correct the options. The\r\n     \"for\" command above indiscriminately inserts \"--with-\" for all modules,\r\n     but bundled modules may require \"--enable-\" instead, so mostly you'll\r\n     be changing those. For modules that are enabled by default you'll need\r\n     to remove the entry.\r\n\r\n6. Add anything else you personally want or need. I like to add \"--enable-safe-mode\".<\/pre>\n<p>After doing all of that, I had the following in phpconfigure.sh<br \/>\n[code lang=&#8221;bash&#8221;]<br \/>\n#!\/bin\/bash<br \/>\n.\/configure &#8211;prefix=\/usr\/share\/ &#8211;datadir=\/usr\/share\/php &#8211;libdir=\/usr\/share &#8211;includedir=\/usr\/include &#8211;bindir=\/usr\/bin &#8211;enable-safe-mode &#8211;with-config-file-path=\/etc\/php542 &#8211;enable-force-cgi-redirect &#8211;enable-discard-path &#8211;with-bz2 &#8211;enable-calendar &#8211;with-curl &#8211;enable-dbase &#8211;enable-exif &#8211;enable-ftp &#8211;with-gettext &#8211;with-gmp &#8211;with-iconv &#8211;with-ldap &#8211;with-libxml-dir=\/usr\/lib\/ &#8211;enable-mbstring &#8211;with-mime_magic &#8211;with-mysql &#8211;with-mysqli &#8211;with-openssl &#8211;enable-pcntl &#8211;with-pcre-dir=\/usr\/lib\/ &#8211;with-pdo_mysql &#8211;with-pdo_sqlite &#8211;with-readline &#8211;enable-shmop &#8211;enable-sockets &#8211;with-SQLite &#8211;enable-wddx &#8211;with-xsl &#8211;enable-zip &#8211;with-zlib<\/p>\n<p># Changes from what php -m spits out. You don&#8217;t need the info below in your phpconfigure.sh script<br \/>\n#&#8211;enable-calendar<br \/>\n#&#8211;with-ctype # default<br \/>\n#&#8211;with-date # not found, default?<br \/>\n#&#8211;enable-dbase<br \/>\n#&#8211;with-dom # default<br \/>\n#&#8211;enable-exif<br \/>\n#&#8211;with-filter #default<br \/>\n#&#8211;with-ftp<br \/>\n#&#8211;with-hash #default<br \/>\n#&#8211;with-json #default<br \/>\n#&#8211;with-libxml-dir=\/usr\/lib\/<br \/>\n#&#8211;enable-mbstring<br \/>\n#&#8211;with-memcache #not found, default?<br \/>\n#&#8211;enable-pcntl<br \/>\n#&#8211;with-pcre-dir=\/usr\/lib\/<br \/>\n#&#8211;with-PDO #taken care of with the pdo_mysql and pdo_sqlite<br \/>\n#&#8211;with-Reflection #default<br \/>\n#&#8211;with-session #default<br \/>\n#&#8211;enable-shmop<br \/>\n#&#8211;with-SimpleXML #default<br \/>\n#&#8211;enable-sockets<br \/>\n#&#8211;with-SPL #default<br \/>\n#&#8211;with-standard #not found, is it SPL? default?<br \/>\n#&#8211;with-tokenizer #default<br \/>\n#&#8211;enable-wddx<br \/>\n#&#8211;with-xdebug #not found, not needed<br \/>\n#&#8211;with-xml #default<br \/>\n#&#8211;with-xmlreader #default<br \/>\n#&#8211;with-xmlwriter #default<br \/>\n#&#8211;enable-zip<br \/>\n#&#8211;with-Xdebug #not found, not needed<\/p>\n<p>[\/code]<\/p>\n<p><strong>NOTE:<\/strong> make sure you do not include &#8216;&#8211;with-apxs2=\/usr\/sbin\/apxs&#8217;. This is what installs PHP as an Apache module. Also, since you have the original PHP running, you can theoretically make a phpinfo file (with phpinfo() ) in it, and grab the configure entries from that, making sure to change &#8216;&#8211;with-config-file-path=\/etc&#8217; &#8216;&#8211;with-config-file-scan-dir=\/etc\/php.d&#8217;<\/p>\n<p>During the configure, you might run into some errors. Again from the php.net comment:<\/p>\n<pre>Configure script errors\r\n--------------------------------------------\r\nIn my experience, these errors have been due (with any software, PHP included) mostly to missing\r\ndevelopment packages, which contain the libraries and headers needed to compile support for that\r\nlibrary's function into the application.\r\n\r\nThis becomes a process of:\r\n-executing the .\/configure script and looking at the error\r\n-installing the devel package providing the resource referenced by the error (google using the error\r\n     as search term as needed)\r\n-repeat until the .\/configure script makes it through without error\r\n\r\nUpshot: identify the software referenced by the error, and install it.\r\n\r\nExample\r\n-----------\r\nExample error:\r\n     configure: error: Cannot find OpenSSL's\r\nExample explanation\r\n     configure is looking for a header (and probably a lot of other stuff) from a missing openssl package.\r\nExample solution:\r\nphp-5.2.9]$sudo yum install openssl-devel<\/pre>\n<p>The previous yum command should take care of most of those dependencies.<\/p>\n<p>After the phpconfigure script runs without errors, then simply run<\/p>\n<pre>$ make<\/pre>\n<p>As the JpGraph tutorial explains, there is no need to run &#8220;make install&#8221;. Just simply copy the php-cgi executable to the proper place. We&#8217;ll get to that step shortly.<\/p>\n<h3>Set up Apache VirtualHost and website directories<\/h3>\n<p>Now you need to create two directories to handle the PHP as CGI. They can be virtually wherever, but should be in the same directory where you have the main html content. So if you set the path to the website data (in the httpd.conf) to \/path\/to\/htdocs\/, then you&#8217;ll need to make a \/path\/to\/php524\/ and a \/path\/to\/php524-cgi\/<\/p>\n<pre>$ mkdir \/path\/to\/php524\/<\/pre>\n<p>and<\/p>\n<pre>$ mkdir \/path\/to\/php524-cgi\/<\/pre>\n<p>After you have those directories, you can add the VirtualHost information to the Apache config (httpd.conf). I like to have a separate file for the VirtualHosts, so I added this to the end of the httpd.conf file.<\/p>\n<pre>Include conf\/XXXXX_vhosts.conf<\/pre>\n<p>And to allow VirtualHosts, uncomment this line:<\/p>\n<pre>NameVirtualHost *:80<\/pre>\n<p>To allow Apache to listen on (or accept requests from) different ports besides the default 80, add another Listen line to the httpd.conf file:<\/p>\n<pre>Listen XXX.XXX.XXX.XXX:8524<\/pre>\n<p>I used port 8524 to correspond to version 5.2.4 of PHP<\/p>\n<p>Now create the XXXXX_vhosts.conf file<\/p>\n<p>[code lang=&#8221;bash&#8221;]<br \/>\n#this doesn&#8217;t really seem to be needed, but it&#8217;s there<br \/>\nNameVirtualHost *:8524<\/p>\n<p># this is the original and runs the PHP as a module<\/p>\n<p>DocumentRoot \/path\/to\/htdocs\/<br \/>\nServerName somesite.org<\/p>\n<p>####### Add other Virtual Hosts below here #######<\/p>\n<p># Setup PHP 5.2.4 on port 8524<\/p>\n<p>DocumentRoot \/path\/to\/php524\/<br \/>\n# We use a separate CGI directory<br \/>\nScriptAlias \/cgi-bin\/ \/path\/to\/php524-cgi\/<\/p>\n<p># These are the two critical statements for this virtual<br \/>\n# host. This activates PHP 5.2.4 as a CGI module<br \/>\nAction php524-cgi \/cgi-bin\/php-cgi<br \/>\nAddHandler php524-cgi .php5 .php<\/p>\n<p>#Options None<br \/>\nOptions FollowSymLinks<br \/>\n#AllowOverride None<br \/>\nAllowOverride All<br \/>\nOrder allow,deny<br \/>\nAllow from all<br \/>\n# For good measure we also add recognition of PHP5 index<br \/>\nDirectoryIndex index.html index.php index.php5<\/p>\n<p>[\/code]<\/p>\n<p>Now, you need to copy the php-cgi binary\/executable to the \/path\/to\/php524-cgi\/ directory. The php-cgi file is located in the file where you ran the configure and make for the new php install. So if you did all that in the \/opt\/php-5.2.4\/ directory, the php-cgi will be located at \/opt\/php-5.2.4\/sapi\/cgi\/php-cgi.<\/p>\n<pre>$ cp \/opt\/php-5.2.4\/sapi\/cgi\/php-cgi \/path\/to\/php524-cgi\/<\/pre>\n<p>Finally, copy the php.ini file to the right place. And configure as needed.<\/p>\n<pre>$ cp \/opt\/php-5.2.4\/php.ini-dist \/path\/to\/php524-cgi\/php.ini<\/pre>\n<p>Test the apache configs to make sure they work:<\/p>\n<pre>$ \/usr\/sbin\/apachectl configtest<\/pre>\n<p>If that returns OK restart Apache.<\/p>\n<pre>$ \/etc\/init.d\/httpd graceful<\/pre>\n<p>You can make a phpinfo page to test that it&#8217;s using the new PHP version.<br \/>\n[code lang=&#8221;php&#8221;]<br \/>\n&lt; ?php<br \/>\nphpinfo();<br \/>\n? &gt;<br \/>\n[\/code]<br \/>\nThen check out your new site: http:\/\/somesite.org:8524\/phpinfo.php<\/p>\n<p>In order to get the different versions of PHP to interact with MySQL, you&#8217;ll have to use the URL on port 80 as the MySQL host. So, for example, in a WordPress install at http:\/\/somesite.org:8524\/blog, the wp-config.php will have to have the following for the MySQL hostname:<\/p>\n<pre>define('DB_HOST', 'dev.omeka.org');<\/pre>\n<p>There is some issue with mod_rewrite on the different versions of PHP. I&#8217;ll replace this paragraph with a fix when I have one.<br \/>\nUPDATE: 9\/9\/09 &#8211; I figured out how to get the .htaccess working for the <a href=\"http:\/\/omeka.org\">Omeka<\/a> installs we were working with. I needed to change the AllowOverride lines in the vhost.conf (or httpd.conf) file from None, to All.<\/p>\n<p>Well, there you go. Hope that&#8217;s enough detail to get you going.<\/p>\n","protected":false},"excerpt":{"rendered":"<p>&nbsp; Long-winded Introduction It took me a couple of days to figure this out due to lack of decent tutorials and not enough confidence in my Linux skills to build programs from source. I think I have the hang of it now, and write this up with the intent on providing another, or the only, &hellip; <a href=\"https:\/\/mossiso.com\/2009\/09\/02\/multiple-php-instances-with-one-apache\/\" class=\"more-link\">Continue reading <span class=\"screen-reader-text\">Multiple PHP Instances With One Apache<\/span><\/a><\/p>\n","protected":false},"author":1,"featured_media":1440,"comment_status":"closed","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":{"jetpack_post_was_ever_published":false,"_jetpack_newsletter_access":"","_jetpack_dont_email_post_to_subs":false,"_jetpack_newsletter_tier_id":0,"footnotes":"","jetpack_publicize_message":"","jetpack_publicize_feature_enabled":true,"jetpack_social_post_already_shared":false,"jetpack_social_options":{"image_generator_settings":{"template":"highway","enabled":false}}},"categories":[3,243,167],"tags":[20,23,28,53,56,63,69,81],"class_list":["post-311","post","type-post","status-publish","format-standard","has-post-thumbnail","hentry","category-coding","category-howto","category-technical","tag-apache","tag-bash-code","tag-centos","tag-httpd","tag-lamp","tag-mysql","tag-php","tag-tutorial"],"jetpack_publicize_connections":[],"jetpack_featured_media_url":"https:\/\/mossiso.com\/wp-content\/uploads\/2009\/09\/php-httpd-php.png","jetpack_sharing_enabled":true,"jetpack_shortlink":"https:\/\/wp.me\/p9wosP-51","_links":{"self":[{"href":"https:\/\/mossiso.com\/wp-json\/wp\/v2\/posts\/311"}],"collection":[{"href":"https:\/\/mossiso.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/mossiso.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/mossiso.com\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"https:\/\/mossiso.com\/wp-json\/wp\/v2\/comments?post=311"}],"version-history":[{"count":6,"href":"https:\/\/mossiso.com\/wp-json\/wp\/v2\/posts\/311\/revisions"}],"predecessor-version":[{"id":1442,"href":"https:\/\/mossiso.com\/wp-json\/wp\/v2\/posts\/311\/revisions\/1442"}],"wp:featuredmedia":[{"embeddable":true,"href":"https:\/\/mossiso.com\/wp-json\/wp\/v2\/media\/1440"}],"wp:attachment":[{"href":"https:\/\/mossiso.com\/wp-json\/wp\/v2\/media?parent=311"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/mossiso.com\/wp-json\/wp\/v2\/categories?post=311"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/mossiso.com\/wp-json\/wp\/v2\/tags?post=311"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}