{"id":1593,"date":"2014-04-02T15:40:56","date_gmt":"2014-04-02T19:40:56","guid":{"rendered":"http:\/\/mossiso.com\/?p=1593"},"modified":"2014-04-02T15:53:07","modified_gmt":"2014-04-02T19:53:07","slug":"atop-apache-top-for-keeping-tabs-on-the-web-servers","status":"publish","type":"post","link":"https:\/\/mossiso.com\/2014\/04\/02\/atop-apache-top-for-keeping-tabs-on-the-web-servers\/","title":{"rendered":"Atop &#8211; Apache Top, for keeping tabs on the web servers"},"content":{"rendered":"<p>When I first became a systems administrator of a large web server, I wanted to know what the current traffic to all of the virtual hosts (vhosts) looked like. I wanted to see which domains were getting the most traffic and where that traffic was coming from. So began my long search for a sufficient tool. There are many out there (<a href=\"https:\/\/github.com\/fr3nd\/apache-top\" target=\"_blank\">apache-top<\/a>, <a href=\"https:\/\/github.com\/JeremyJones\/Apachetop\" target=\"_blank\">Apachetop<\/a>, <a href=\"https:\/\/github.com\/ClockworkNet\/wtop\" target=\"_blank\">wtop<\/a>, <a href=\"http:\/\/hisham.hm\/htop\/\">htop<\/a>, <a href=\"http:\/\/iptraf.seul.org\/\">IPTraf<\/a>, etc). But they didn&#8217;t do all of the things I wanted. Basically they were just command line versions of the output of Apache mod_status, or they did complex log analysis.<\/p>\n<p>I wanted more. The ability to search, or show only a certain domain name, see a list of IP address and how many connections from that IP address (to detect botnet attacks), and more.<\/p>\n<p>So in true sys admin fashion, I built the tool myself. It is sufficiently stable and usable enough to warrant a blog post and hopefully engender some usage by others, which hopefully will encourage ideas and improvements from the community. Go ahead and grab a copy from the github repo,\u00a0<a href=\"https:\/\/github.com\/mossiso\/atop\" target=\"_blank\">https:\/\/github.com\/mossiso\/atop <\/a><\/p>\n<p>My idea is not much different than some of the tools I linked to. I&#8217;m basically writing a wrapper around the Apache mod_status output, but this tool has the ability to do more. So here&#8217;s a little walk through of what this tool does.<\/p>\n<h2>Requirements<\/h2>\n<ul>\n<li><strong>Apache with mod_status<\/strong>: This tool is built around the Apache mod_status output, so that obviously has to be installed and set up. The ExtendedStatus option has to be enabled in the httpd.conf file.<\/li>\n<li><strong>links:<\/strong> This is a command line based web browser of sorts. Using the -dump flag, it just spits out the page to the command line.<\/li>\n<li><strong>netstat:<\/strong> This is used for one of the options to display all of the IPs connected to the webserver (via port 80).<\/li>\n<\/ul>\n<p>&nbsp;<\/p>\n<p>This tool is just a BASH script, so once you download the &#8220;atop&#8221; file, just plop it anywhere in your home directory on your web server, change the permissions so it is executable<\/p>\n<p>[code lang=&#8221;bash&#8221;]chmod 700 atop[\/code]<\/p>\n<p>and run it<\/p>\n<p>[code lang=&#8221;bash&#8221;].\/atop[\/code]<\/p>\n<p>There are now several options you can sort the results by:<\/p>\n<pre>==============================================================\r\na = sort all threads by time\r\nc = sort by CPU, no GCRK_\r\ni = list IPs connected to port 80 (uses Apache Server Status)\r\nk = sort by K (Keep alives)\r\nl = list IPs connected to all ports (uses netstat)\r\nn = list IPs connected to port 80 (uses netstat)\r\no = sort open connections by CPU\r\np = sort only POST threads by time\r\nr = raw apache status output (good with limit of at least 50)\r\ns = search for a term, returns raw Apache Server Status results\r\nw = sort by inactive workers\r\nq = quit<\/pre>\n<p>To see the list of options while the command is running, just type any key on the keyboard.<\/p>\n<p>Getting the BASH script to be responsive to the keyboard was tricky, and took me the longest time to figure out. For a while I could get the results to be displayed and refresh every N seconds, I could even get it to do the sort options, but only if I started the script with that option. So I was super excited to figure out the logic to get the script to respond to input.<\/p>\n<p>The trick lies in setting the output commands in an infinite while loop. At the end of the loop it does a regular bash prompt using &#8220;read&#8221;. Normally this waits for a response, but the timeout feature allows you to set that to one second, which then goes through the while loop again. If a key is pressed, it breaks the while loop and prints the options message. When an option is selected it goes through that while loop.<\/p>\n<h2>Features<\/h2>\n<p>Some of the sort options I use most often are POST (p), CPU (c), IPs according to Apache (i), and IPs according to the server (n). I walk through those one by one.<\/p>\n<h3>POST<\/h3>\n<p><a href=\"http:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/POST-listing1.png\"><img loading=\"lazy\" decoding=\"async\" class=\"alignnone size-full wp-image-1610\" alt=\"POST-listing\" src=\"http:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/POST-listing1.png\" width=\"890\" height=\"322\" srcset=\"https:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/POST-listing1.png 890w, https:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/POST-listing1-300x108.png 300w, https:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/POST-listing1-250x90.png 250w, https:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/POST-listing1-150x54.png 150w, https:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/POST-listing1-624x225.png 624w\" sizes=\"(max-width: 890px) 100vw, 890px\" \/><\/a><\/p>\n<p>This is probably the most helpful of the options. Usually, when a website is getting hammered, it&#8217;s because it is getting comment spam or login attempts. These all require POST requests. If you see a large number of POST requests for a single vhost, then look at the IP addresses sending the requests; you can bet if all the requests are from the same IP, that it should be blocked.<\/p>\n<h3>CPU<\/h3>\n<p><img loading=\"lazy\" decoding=\"async\" class=\"alignnone size-full wp-image-1607\" alt=\"CPU-list\" src=\"http:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/CPU-list.png\" width=\"990\" height=\"1046\" srcset=\"https:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/CPU-list.png 990w, https:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/CPU-list-283x300.png 283w, https:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/CPU-list-969x1024.png 969w, https:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/CPU-list-250x264.png 250w, https:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/CPU-list-141x150.png 141w, https:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/CPU-list-624x659.png 624w\" sizes=\"(max-width: 990px) 100vw, 990px\" \/><\/p>\n<p>This is a pretty good overview of what Apache traffic your server is handling. It shows GET and POST requests and sorts them with the most heavy CPU usage requests on the bottom. It filters out open processes with no connections, and a few other things like closing connections.<\/p>\n<h3>IPs (Apache)<\/h3>\n<p><img loading=\"lazy\" decoding=\"async\" class=\"alignnone size-full wp-image-1605\" alt=\"IP-Apache-list\" src=\"http:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/IP-Apache-list.png\" width=\"459\" height=\"504\" srcset=\"https:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/IP-Apache-list.png 459w, https:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/IP-Apache-list-273x300.png 273w, https:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/IP-Apache-list-250x274.png 250w, https:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/IP-Apache-list-136x150.png 136w\" sizes=\"(max-width: 459px) 100vw, 459px\" \/><\/p>\n<p>This one is great, too. It shows the IP addresses that are connected to Apache, and sorts them by how many connections are being made. The IPs with the most connections are at the bottom. If you see an IP address with over 10 connections for a few minutes, you can bet they are up to no good. Double check with the POST option to see if they are spamming.<\/p>\n<h3>IPs (Netstat)<\/h3>\n<p><img loading=\"lazy\" decoding=\"async\" class=\"alignnone size-full wp-image-1608\" alt=\"IP-Netstat-list\" src=\"http:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/IP-Netstat-list.png\" width=\"440\" height=\"662\" srcset=\"https:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/IP-Netstat-list.png 440w, https:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/IP-Netstat-list-199x300.png 199w, https:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/IP-Netstat-list-250x376.png 250w, https:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/IP-Netstat-list-99x150.png 99w\" sizes=\"(max-width: 440px) 100vw, 440px\" \/><\/p>\n<p>This option gets all traffic to port 80 using netstat. It filters out local traffic (and GMU traffic, but you can edit that out), and then does the sorting and organizing by how many IP addresses are connecting. This gives a little more detail than the other IP option.<\/p>\n<p>If you find any bugs in the script or have a great idea for other options, feel free to fork or submit patches, or report bugs on the <a href=\"https:\/\/github.com\/mossiso\/atop\">github repo<\/a>.<\/p>\n","protected":false},"excerpt":{"rendered":"<p>When I first became a systems administrator of a large web server, I wanted to know what the current traffic to all of the virtual hosts (vhosts) looked like. I wanted to see which domains were getting the most traffic and where that traffic was coming from. So began my long search for a sufficient &hellip; <a href=\"https:\/\/mossiso.com\/2014\/04\/02\/atop-apache-top-for-keeping-tabs-on-the-web-servers\/\" class=\"more-link\">Continue reading <span class=\"screen-reader-text\">Atop &#8211; Apache Top, for keeping tabs on the web servers<\/span><\/a><\/p>\n","protected":false},"author":1,"featured_media":1601,"comment_status":"closed","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":{"jetpack_post_was_ever_published":false,"_jetpack_newsletter_access":"","_jetpack_dont_email_post_to_subs":false,"_jetpack_newsletter_tier_id":0,"footnotes":"","jetpack_publicize_message":"","jetpack_publicize_feature_enabled":true,"jetpack_social_post_already_shared":false,"jetpack_social_options":{"image_generator_settings":{"template":"highway","enabled":false}}},"categories":[243,259,167,170],"tags":[20,273,274,216],"class_list":["post-1593","post","type-post","status-publish","format-standard","has-post-thumbnail","hentry","category-howto","category-systems-administration-technical","category-technical","category-websites","tag-apache","tag-atop","tag-monitoring","tag-system-administration"],"jetpack_publicize_connections":[],"jetpack_featured_media_url":"https:\/\/mossiso.com\/wp-content\/uploads\/2014\/04\/atop-github-page.png","jetpack_sharing_enabled":true,"jetpack_shortlink":"https:\/\/wp.me\/p9wosP-pH","_links":{"self":[{"href":"https:\/\/mossiso.com\/wp-json\/wp\/v2\/posts\/1593"}],"collection":[{"href":"https:\/\/mossiso.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/mossiso.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/mossiso.com\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"https:\/\/mossiso.com\/wp-json\/wp\/v2\/comments?post=1593"}],"version-history":[{"count":10,"href":"https:\/\/mossiso.com\/wp-json\/wp\/v2\/posts\/1593\/revisions"}],"predecessor-version":[{"id":1611,"href":"https:\/\/mossiso.com\/wp-json\/wp\/v2\/posts\/1593\/revisions\/1611"}],"wp:featuredmedia":[{"embeddable":true,"href":"https:\/\/mossiso.com\/wp-json\/wp\/v2\/media\/1601"}],"wp:attachment":[{"href":"https:\/\/mossiso.com\/wp-json\/wp\/v2\/media?parent=1593"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/mossiso.com\/wp-json\/wp\/v2\/categories?post=1593"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/mossiso.com\/wp-json\/wp\/v2\/tags?post=1593"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}